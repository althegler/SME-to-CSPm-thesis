% This section should contain information about the problem, but not the solution. I am analysing the problem and explaining what will be problematic when translating from SMEIL to CSPm.

% Der er tre dele i SMEIL jeg har interesse i:
% Three components: Behavioral, structural, meta data

% Jeg skal ikke fortælle hvordan jeg har gjort det men analyse af problemet og ikke af løsningen. Jeg skal blot beskrive problemstillingerne.




\section{Transpiling SMEIL to \cspm{}} \label{sec:transpiling}
When transpiling from source to source the difficult part is to understand the structure of each language and to understand how to translate structures from one language to the other without losing functionality but still maintaining the structure of each language.

When transpiling from SMEIL to \cspm{} the goal was to find a method for transpiling, that could be generalized to most problems. We have worked on separation of concerns in order to simplify, but also to have a greater chance of being able to match more SMEIL programs.

% TODO: Something about functional language to imperative language


% Vigtigt at have de tre dele adskilt i afsnittet. Brug figuren fra side 107 i bujo til at henvise til at jeg har en Magic 8-ball (Mit system) og jeg skal fra SMEIL til FDR og henvise til at det er det flow jeg har brug for.


% I SMEIL har jeg et prædefineret konsistent navnerum. Jeg skal ikke lave en symboltabel. Jeg arver direkte fra SMEIL til CSPm. Så her kan jeg snakke om at hvis jeg gjorde det på en anden måde ville jeg ikke kunne gøre det sådan. Det skal jeg skrive om her.

Usually when doing any form of translation either by a compiler or interpreter, the use of a symbol table is often needed in order to keep information about variable names, function names, classes, communication ect. Usually the translation, when reaching a symbol in the translation, use the symbol table to look up a symbol and retrieve its context if it has any information about said symbol. This can be to check that a variable have been declared or for type checking ect.. The symbol table is usually generated in the analysis section and are used for look ups througout the compilation or interpretation.



When analysing the general structure of SMEIL programs, there are three structures that are particular interesting when we are interested in translating from SMEIL to \cspm{}. These three structures are:
\begin{enumerate}
    \item \textbf{Behavioral:} The general behavior of each process and function.
    \item \textbf{Structural:} How the circuit is connected, i.e which buses connects to which processes.
    \item \textbf{Meta information/Observed values} %TODO: Meta information or observed values?:
    The information that are meta information but provides an understanding of what data flows through the network.
\end{enumerate}


\subsection{Behavioral}
%% - Behavioral description - hvad den enkelte funktion gør. det oversættes ret nemt. Jeg bekymre mig ikke om variable og sådan nogle ting. Det er allerede gjort før det gøres til SMEIL, og dem kan jeg genbruge i min code generation.  Funktionel indhold af processer/ opførsel af den enkelte process - det er rimelig nemt oversat direkte til CSPm. Her kan man beskrive hvis der er nogle sproglige udfordringer, fx hvis CSPm ikke har loops eller lign.

From the introduction to both SMEIL and \cspm it is clear that the main intention of each language is different and therefore the transpiling of a process in SMEIL to a \cspm process might not be completely trivial. All data from the SMEIL process will need to be translated into data and structures within the \cspm model, calculations and communications alike.
  % TODO: Understand CSPm processes better
A process in SMEIL is defined by the \texttt{proc} keyword and then consists of bus and variable declarations, the statements to be run for each clock cycle as well as the outgoing communication from the process. This is a somewhat recognisable function structure for functional languages. In \cspm the structure is commonly consisting of communication which might include some kind of calculations, but the main purpose of \cspm processes are usually to express communication. %TODO: Add reference to FDR example (I took it from FDRs website - test example https://www.cs.ox.ac.uk/projects/fdr/manual/examples/index.html. Dining Philosophers)

\begin{listing}
\begin{minted}[escapeinside=||, mathescape=true]{cspm_lexer.py:CSPmLexer -x}
PHIL(i) = thinks.i -> sits!i -> picks!i!i -> picks!i!((i+1)%N) ->
          eats!i -> putsdown!i!((i+1)%N) -> putsdown!i!i -> getsup!i -> PHIL(i)

\end{minted}
\caption{x}
\label{x}
\end{listing}

However, since we do have the process processes in both SMEIL and \cspm, transpiling SMEIL to \cspm should be possible since the general behaviour can be created in \cspm. The main two things important in the behaviour of an SMEIL program is the communication and the calculations. The communication will be possible to transpile in a fairly simple manner, and since \cspm is based on mixing the CSP algebra with a functional language, the calculations should also be possible to transpile in a reasonable manner.
For simplicity of the generated code, it would be beneficial to be able to keep the communication and calculations from the same SMEIL process in the same \cspm structure.

%% Translating variables directly because we expect errors or other things to have been handled before transpiling the code.
When translating the process from SMEIL to \cspm we will be able to translate variables and calculations directly without having to translate the meaning of the it, since we are expecting SMEIL to handle behavioural errors.

% TODO: Write something more about FDR not supporting floating point
When translating from SMEIL to \cspm we will run into a problem with floating point numbers. SMEIL does support floating point numbers, but FDR4 does not, %TODO: add reference. is it only FDR4 or is it build into CSP not to support it?
and therefore we will have to convert the floating point numbers to integer, or simply not trying to verify programs that rely on floating poing numbers. The reason FDR does not support floating point numbers are... %TODO: write more here


%% I cannot assume that the output bus is defined in a busdeclaration in the process
In an SMEIL, each process can have any number and combinations of input buses, output buses and constant parameters and since SMEIL have been created so that the creation of a circuit gives the most flexibility, we have to handle several different ways of defining these in \cspm.
Process input buses can be defined in the parameter when defining the process or the communication can be created by directly using the buses through their hierarchical names %TODO: reference truls master page 20

Process output buses can be defined the same as input buses; as a parameter in the process or by using the hierarchical names of the buses. It is also possible not to have the output bus defined in the parameters but to have a bus declaration inside the process description.

Constants can also be defined as a parameter and as a constant declaration within the process description. %TODO: Find out more about constants. are we interested in them, then I need to write more, otherwise I can close this part early.
When transpiling to \cspm there is a need for the transpiler to be able to recognize all different ways of defining buses and constants within the SMEIL program.

%% What to do if there is several channels in one bus that acts as an input bus for a process.
In SMEIL each bus can consist of several different channels. When accessing the communicated values, the process have to refer to the specific bus and the specific channel name. In \cspm all communications are done with channels. The translation between SMEIL buses and \cspm channels should be straightforward, since channels is a subset of buses in SMEIL and therefore a bus with two channels would be the same as two buses with one channel. However, when defining the input for the proceses in SMEIL, only the bus name is used and therefore the transpiling will have to be able to recognize which channels belongs to which bus in order to give the correct channels as input for the \cspm processes.


%%%%% Generator processes %%%%%
When writing pure SMEIL programs, there is a need to generate input for the network. If the program was not written as pure SMEIL, the input for the network would be provided by the surrounding code. But in the case of pure SMEIL, the input data must be generated which is done by a generator process.
%%% Generator processes - clock cycles
The transpiler must be able to handle all these different processes and must ensure that the data are representing all possible values from the SMEIL program. \cspm are not able to simulate clock cycles and therefore all data communicated in the \cspm program will represent the clock cycles from the SMEIL representation.
%TODO: Remember to introduce the simulation of SMEIL somewhere and introduce ranges etc. so the clock cycle thing makes sense.
%TODO: Is this section too much design and not really analysis?
%TODO: Not sure if the clock cycle thing should be here or somewhere else.

%%% Generator processes - no input bus process.
A generator process in SMEIL can be constructed in several diffent ways, which can be seen in Figure %TODO: Add reference to figure of the different generator processs.
In some cases the process have no input bus, since it is instantiated with a value within the process, as in Figure %TODO: reference to specific figure part.
We can assume that all SMEIL processes with no input bus will be a data generator process of some kind, and therefore must have some outwards communication. %TODO: Can we really assume this? think about it once again.

%% Generator processes - input bus with const declared
It becomes a bit more tricky if the process have an input bus, because it is to receive data later on, but it also works as an instantiator, either by having a value defined in the process declaration %TODO: Is this possible? Fx. if clock() had an input bus but still generated the starting point.
or by having a constant as an input argument in the process parameters. In this case the transpiler will have to recognize the data generator process or the initial starting point of the network and generate the data of the network from that. %TODO: Add an example that shows a generator process without an input, where it is generated as in 7segexample, also a version like the addone example and others if I can come up with them.
%TODO: also add text that explain each of them
In \cspm it is not possible to create a loop which generates data. Since the purpose of \cspm or FDR4 is to look at all possible states of a system, a loop generating data would not make sense. Typically the data possible for the system are defined in channel definitions or initialized via a parameter for a process function, both types can be seen in Figure %TODO: Add figure with two types of data generation in \cspm. Fx. either Var(0) or channel X : 0.
Here it becomes crucial that the transpiler generates the data correctly so the system checks all possible values, but still keep the structure of the network intact, and therefore it might be necessary to seperate the data generation from the process in order to keep the process task intact.

%%% Generator processes - More than one process
In SMEIL it is possible to have more than one proces which generates data for the network. These processes can generate data in all the ways described above, and can be combined together in various ways. In the case of more than one generator process with no input bus, it should not be more complex to translate than the case with one single data generator process, since the processes task still only consist of generating data and communicating them via their outbus bus. The receiving process are declared in the SMEIL network structure and therefore as long as the transpiler generates the same network in \cspm, it will not matter wheather there are one or more data generator processes.
If the generator processes are part of the network as the process in x%TODO: Create a reference to an example like the one in AddOne, where the process is a generator process but still have a task to do afterwards.
then the translation will have to create the data without destroying the purpose of the process, %TODO: Write some more here when I know more. If having more than one generator process with an input bus, does not change the solution from having one generator process with an input bus, then write that, else write how to solve it if there are more than one and why it is different than having one generator process with input bus.





% %%%% Channels %%%%%
In SMEIL channels are an integrated part of the bus and in \cspm the only communication device is a channel. Therefore when translating from SMEIL to \cspm, the transpiler have to be cautious and make sure to translate without losing data or functionality.
% %%%% Calling the channel in the bus
In SMEIL, the processes refer to its input buses and output buses, but when calling to receive or to send, the process wil have to call the specific channel in that specific bus.
% TODO: Add an example where a process calls the channel in the input bus. Also create an example where the bus is not defined with channels.

% %%%% Bus only defined as parameter
If the (output?) bus is not defined with channels, as can be seen in figure x,
% TODO: Create reference to the figure created above
the process still needs to reference that specific channel in the bus. It is not possible in SMEIL to call a bus without a channel. So when the bus is called, as long as the channel called match what has been defined as channels for that specific bus, then all is good. The translation of this should be rather simple, since all buses consists of channels, all channels should be possible to translate directly to \cspm channels.
% %%%% Channel names
The difficult part of translating SMEIL channels to \cspm channels will be to be sure that the naming is unique. In SMEIL the names of the channels are local to the bus, but in \cspm all channels are global. Therefore the naming of the channels needs to be unique and then all references to the channels in SMEIL should be possible to reuse with the \cspm channel naming.
% TODO: write something about adding the range of the channel to \cspm






\subsection{Structural}
% - Strukturel information: hvilke proceser er der og hvilke buser er de limet sammen med. hvordan hænger tingene sammen. Det er også forholdsvis nemt fordi FDR har processer på samme måde som SMEIL har. de har en historisk afhængighed ift. SME og CSP.

The network in an SMEIL program is the crucial part which ties all the processes and communication together. In the network buses or instances of processes are defined as well as the input and output for those proceses. In order to generate a correct network in \cspm the translation of the SMEIL network is crucial. In \cspm there is also a structure that is similar to the network structure in SMEIL. When synchronizing processes together with channels in a new process in \cspm we create the structure of what channels each process communicates on and which processes communicate to which processes. This translation step will require carefully planning in order to get all the information for each part, in the correct position of one another. In SMEIL buses can also be declared in the network declaration but.. %TODO: ...currently the system does not handle other than pure SMEIL programs and therefore we do not need to handle if these buses are not both an input and output bus in some processes.

% TODO: Write about two networks and how it will be translated to a network and therefore we should be able to have them seperated easily and the communication is what combines them, and that is the same in cspm.

% TODO: Write about how one process can be defined in SMEIL several times and how it does not matter, since the process will be defined the same in CSPm but that the network will simply be generated twice with two different names and inputs or similar. (Does that also work if it is different output?)




\subsection{Meta}
% - Opserverede værdier - "known limits". Meta information i SMEIL, og det skal oversættes til faktiske processer med faktiske semantic i FDR der også er en del af topologien. (Det er essensen for mig).

In the process description in SMEIL, the channels of a bus are defined as well as the types and observed values for these channels. This data is the crucial data to gather in order for FDR4 to be able to verify the values communicated on the channels. In SMEIL it is simply data that is used when simulating the program or if translated to VHDL
%TODO it is VHDL right?
. The circuit does not need to know exactly what values are communicated or what type that is.


% %%%% Monitor processes %%%%%
When verifying attributes(?) in FDR4, we need some specifics to verify on. One scenario is that we want to verify that no values are communicated on a channel, that does not lie within the expected range. In this case we will have to get the correct data from the SMEIL program and handle them in a way that gives FDR4 something to verify.
% TODO: Maybe write something about getting the ranges and thereby we should simulate or the programmer should annotate the code herself. I have already added some stuff about this in the design part
